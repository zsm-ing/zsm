# ==============================
# MikroTik QoS 终极版 RouterOS 7
# DSCP 版（正确写法）
# WAN: pppoe-out1
# LAN: bridge
# 下行: 480M
# 上行: 45M
# IPv4 五类 + IPv6 三类
# ==============================

# 1. 关闭 FastTrack
/ip firewall filter
disable [find action=fasttrack-connection]

# 2. 定义 PCQ 队列类型
/queue type
add name=pcq-down kind=pcq pcq-classifier=dst-address pcq-rate=0
add name=pcq-up kind=pcq pcq-classifier=src-address pcq-rate=0

# 3. IPv4 DSCP 标记
/ip firewall mangle
# DNS / ACK EF
add chain=prerouting protocol=udp dst-port=53 action=set-dscp dscp=46 passthrough=yes
# 游戏 UDP AF41
add chain=prerouting protocol=udp action=set-dscp dscp=34 passthrough=yes
# 视频 TCP AF21
add chain=prerouting protocol=tcp dst-port=443 action=set-dscp dscp=18 passthrough=yes
# 网页 TCP AF11
add chain=prerouting protocol=tcp dst-port=80,443 action=set-dscp dscp=8 passthrough=yes
# 下载 TCP BE
add chain=prerouting protocol=tcp dst-port=6881-6999 action=set-dscp dscp=0 passthrough=yes

# 4. IPv6 DSCP 标记
/ipv6 firewall mangle
# DNS EF
add chain=prerouting protocol=udp dst-port=53 action=set-dscp dscp=46 passthrough=yes
# 游戏 / 实时 UDP AF41
add chain=prerouting protocol=udp action=set-dscp dscp=34 passthrough=yes
# 普通 TCP AF11 (网页/视频/下载)
add chain=prerouting protocol=tcp action=set-dscp dscp=8 passthrough=yes

# 5. 下行 Queue Tree (480M)
/queue tree
add name=DOWN parent=pppoe-out1 max-limit=480M
add name=DNS-DOWN parent=DOWN packet-mark=dns priority=1 queue=pcq-down limit-at=5M max-limit=20M
add name=GAME-DOWN parent=DOWN packet-mark=game priority=2 queue=pcq-down limit-at=50M max-limit=200M
add name=VIDEO-DOWN parent=DOWN packet-mark=video priority=4 queue=pcq-down limit-at=100M max-limit=300M
add name=WEB-DOWN parent=DOWN packet-mark=web priority=5 queue=pcq-down limit-at=50M max-limit=200M
add name=DL-DOWN parent=DOWN packet-mark=download priority=8 queue=pcq-down limit-at=10M max-limit=150M

# 6. 上行 Queue Tree (45M)
/queue tree
add name=UP parent=pppoe-out1 max-limit=45M
add name=DNS-UP parent=UP packet-mark=dns priority=1 queue=pcq-up limit-at=2M max-limit=5M
add name=GAME-UP parent=UP packet-mark=game priority=2 queue=pcq-up limit-at=10M max-limit=25M
add name=WEB-UP parent=UP packet-mark=web priority=5 queue=pcq-up limit-at=5M max-limit=15M
add name=DL-UP parent=UP packet-mark=download priority=8 queue=pcq-up limit-at=2M max-limit=10M

# 7. 配置说明
# - DSCP 优先级: DNS(EF46) > 游戏(AF41) > 视频(AF21) > 网页(AF11) > 下载(BE0)
# - Queue Tree: packet-mark 与 DSCP 对应，可按需要改为 dscp 匹配
# - PCQ 自动均分多设备带宽
# - IPv4 & IPv6 同步生效
# - RouterOS 7 完全兼容

# ==============================
# 配置完成
# ==============================
