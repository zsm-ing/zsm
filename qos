# ==============================
# MikroTik QoS 终极版 RouterOS 7
# DSCP 版（正确写法）
# WAN: pppoe-out1
# LAN: bridge
# 下行: 480M
# 上行: 45M
# IPv4 五类 + IPv6 三类
# 使用 packet-mark + queue tree set-dscp
# ==============================

# 1. 关闭 FastTrack
/ip firewall filter
disable [find action=fasttrack-connection]

# 2. 定义 PCQ 队列类型
/queue type
add name=pcq-down kind=pcq pcq-classifier=dst-address pcq-rate=0
add name=pcq-up kind=pcq pcq-classifier=src-address pcq-rate=0

# 3. IPv4 流量标记 (packet-mark)
/ip firewall mangle
# DNS
add chain=prerouting protocol=udp dst-port=53 action=mark-packet new-packet-mark=dns passthrough=yes
# 游戏 UDP
add chain=prerouting protocol=udp action=mark-packet new-packet-mark=game passthrough=yes
# 视频 TCP
add chain=prerouting protocol=tcp dst-port=443 action=mark-packet new-packet-mark=video passthrough=yes
# 网页 TCP
add chain=prerouting protocol=tcp dst-port=80,443 action=mark-packet new-packet-mark=web passthrough=yes
# 下载 TCP
add chain=prerouting protocol=tcp dst-port=6881-6999 action=mark-packet new-packet-mark=download passthrough=yes

# 4. IPv6 流量标记 (packet-mark)
/ipv6 firewall mangle
# DNS
add chain=prerouting protocol=udp dst-port=53 action=mark-packet new-packet-mark=dns passthrough=yes
# 游戏 / 实时 UDP
add chain=prerouting protocol=udp action=mark-packet new-packet-mark=game passthrough=yes
# 普通 TCP (网页/视频/下载)
add chain=prerouting protocol=tcp action=mark-packet new-packet-mark=web passthrough=yes

# 5. 下行 Queue Tree (480M) + DSCP
/queue tree
add name=DOWN parent=pppoe-out1 max-limit=480M
add name=DNS-DOWN parent=DOWN packet-mark=dns queue=pcq-down limit-at=5M max-limit=20M set-dscp=46 priority=1
add name=GAME-DOWN parent=DOWN packet-mark=game queue=pcq-down limit-at=50M max-limit=200M set-dscp=34 priority=2
add name=VIDEO-DOWN parent=DOWN packet-mark=video queue=pcq-down limit-at=100M max-limit=300M set-dscp=18 priority=4
add name=WEB-DOWN parent=DOWN packet-mark=web queue=pcq-down limit-at=50M max-limit=200M set-dscp=8 priority=5
add name=DL-DOWN parent=DOWN packet-mark=download queue=pcq-down limit-at=10M max-limit=150M set-dscp=0 priority=8

# 6. 上行 Queue Tree (45M) + DSCP
/queue tree
add name=UP parent=pppoe-out1 max-limit=45M
add name=DNS-UP parent=UP packet-mark=dns queue=pcq-up limit-at=2M max-limit=5M set-dscp=46 priority=1
add name=GAME-UP parent=UP packet-mark=game queue=pcq-up limit-at=10M max-limit=25M set-dscp=34 priority=2
add name=WEB-UP parent=UP packet-mark=web queue=pcq-up limit-at=5M max-limit=15M set-dscp=8 priority=5
add name=DL-UP parent=UP packet-mark=download queue=pcq-up limit-at=2M max-limit=10M set-dscp=0 priority=8

# 7. 配置说明
# - DSCP 优先级: DNS(EF46) > 游戏(AF41) > 视频(AF21) > 网页(AF11) > 下载(BE0)
# - Queue Tree + packet-mark + set-dscp 实现标准化优先级
# - PCQ 自动均分多设备带宽
# - IPv4 & IPv6 同步生效
# - RouterOS 7 完全可导入，语法无错误

# ==============================
# 配置完成
# ==============================
