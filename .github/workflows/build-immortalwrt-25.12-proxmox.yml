name: Build ImmortalWRT x86_64 Firmware

on:
  workflow_dispatch:
    inputs:
      use-local-config:
        description: '是否使用仓库里的 .config 文件？(yes/no)'
        required: true
        default: 'yes'
      enable-ccache:
        description: '是否启用编译缓存？(yes/no)'
        required: true
        default: 'yes'
      make-jobs:
        description: '并行编译任务数（0=自动）'
        required: true
        default: '0'
      clean-before-build:
        description: '编译前清理目录？(yes/no)'
        required: true
        default: 'yes'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    steps:
    - name: Free up disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        docker-images: true
        swap-storage: true
        android: true
        dotnet: true
        large-packages: true

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install build dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential \
          ccache \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          flex \
          gettext \
          libssl-dev \
          wget \
          unzip \
          python3 \
          python3-setuptools \
          subversion \
          file \
          bc \
          squashfs-tools \
          dosfstools \
          rsync \
          git \
          curl \
          libelf-dev \
          gcc-multilib \
          automake \
          autoconf \
          bison \
          time \
          xsltproc \
          fastjar \
          java-propose-classpath \
          ecj \
          jq

    - name: Setup ccache
      if: ${{ github.event.inputs.enable-ccache == 'yes' }}
      run: |
        mkdir -p ~/.ccache
        echo "max_size = 4.0G" > ~/.ccache/ccache.conf
        echo "CCACHE_DIR=$(realpath ~/.ccache)" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=4G" >> $GITHUB_ENV
        echo "PATH=/usr/lib/ccache:$PATH" >> $GITHUB_ENV

    - name: Clone ImmortalWRT source
      run: |
        IMMORTAL_DIR="$GITHUB_WORKSPACE/immortal-src"
        
        if [ -d "$IMMORTAL_DIR" ] && [ "${{ github.event.inputs.clean-before-build }}" == "yes" ]; then
          rm -rf "$IMMORTAL_DIR"
        fi
        
        echo "克隆 ImmortalWRT 源码 (分支: openwrt-25.12)..."
        git clone --branch openwrt-25.12 --depth=50 --single-branch \
          https://github.com/immortalwrt/immortalwrt.git "$IMMORTAL_DIR"
        
        cd "$IMMORTAL_DIR"
        
        LATEST_COMMIT=$(git log -1 --format="%H - %s (%ci)")
        echo "IMMORTAL_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
        echo "IMMORTAL_DIR=$IMMORTAL_DIR" >> $GITHUB_ENV
        
        echo "当前分支:"
        git branch -v
        echo "最新提交:"
        git log -1 --oneline

    - name: Apply custom configuration
      run: |
        cd "$IMMORTAL_DIR"
        
        CONFIG_SOURCE="$GITHUB_WORKSPACE/.config"
        CONFIG_TARGET=".config"
        
        if [ "${{ github.event.inputs.use-local-config }}" == "yes" ] && [ -f "$CONFIG_SOURCE" ]; then
          echo "使用自定义配置..."
          cp -v "$CONFIG_SOURCE" "$CONFIG_TARGET"
          
          # 验证配置
          echo "验证配置..."
          if ! grep -q "CONFIG_TARGET_x86" "$CONFIG_TARGET" && ! grep -q "CONFIG_TARGET_x86_64" "$CONFIG_TARGET"; then
            echo "⚠️ 配置中未指定目标架构，添加x86_64目标..."
            echo "CONFIG_TARGET_x86=y" >> "$CONFIG_TARGET"
            echo "CONFIG_TARGET_x86_64=y" >> "$CONFIG_TARGET"
            echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> "$CONFIG_TARGET"
          fi
        else
          echo "使用默认配置或生成新的配置"
        fi

    - name: Update and install feeds
      run: |
        cd "$IMMORTAL_DIR"
        
        echo "更新 feeds..."
        timeout 600 ./scripts/feeds update -a || echo "Feeds更新超时，继续..."
        
        echo "安装 feeds..."
        ./scripts/feeds install -a
        
        echo "安装基础包..."
        ./scripts/feeds install luci luci-base luci-compat || echo "Luci安装失败，继续..."

    - name: Generate default config if needed
      run: |
        cd "$IMMORTAL_DIR"
        
        # 如果没有.config文件，生成一个
        if [ ! -f .config ] || [ "${{ github.event.inputs.use-local-config }}" == "no" ]; then
          echo "生成默认配置..."
          
          # 创建基础配置
          cat > .config-base << 'EOF'
CONFIG_TARGET_x86=y
CONFIG_TARGET_x86_64=y
CONFIG_TARGET_x86_64_DEVICE_generic=y
CONFIG_TARGET_ROOTFS_EXT4FS=y
CONFIG_TARGET_ROOTFS_SQUASHFS=y
CONFIG_TARGET_IMAGES_GZIP=y
CONFIG_VMDK_IMAGES=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-base=y
CONFIG_PACKAGE_luci-compat=y
EOF
          
          # 合并配置
          if [ -f .config ]; then
            cat .config-base .config > .config.tmp
            mv .config.tmp .config
          else
            mv .config-base .config
          fi
          
          # 运行defconfig来填充其他选项
          make defconfig
        fi

    - name: Add swap space for compilation
      run: |
        # 检查现有交换空间
        TOTAL_SWAP=$(free -m | awk '/Swap:/ {print $2}' || echo "0")
        if [ $TOTAL_SWAP -lt 4096 ]; then
          echo "增加交换空间到8G..."
          sudo fallocate -l 8G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
        fi
        
        echo "内存和交换空间状态:"
        free -h

    - name: Calculate optimal job count
      run: |
        # 根据可用内存计算最佳任务数
        TOTAL_MEM_KB=$(grep MemTotal /proc/meminfo | awk '{print $2}')
        TOTAL_MEM_GB=$((TOTAL_MEM_KB / 1024 / 1024))
        
        # 计算CPU核心数
        CPU_CORES=$(nproc)
        
        # 根据内存调整任务数
        if [ $TOTAL_MEM_GB -ge 16 ]; then
          JOBS=$CPU_CORES
        elif [ $TOTAL_MEM_GB -ge 8 ]; then
          JOBS=$((CPU_CORES / 2))
          if [ $JOBS -lt 2 ]; then JOBS=2; fi
        else
          JOBS=2
        fi
        
        # 如果用户指定了任务数，则使用用户指定的
        if [ "${{ github.event.inputs.make-jobs }}" != "0" ]; then
          JOBS=${{ github.event.inputs.make-jobs }}
        fi
        
        echo "JOBS=$JOBS" >> $GITHUB_ENV
        echo "CPU核心数: $CPU_CORES"
        echo "内存: ${TOTAL_MEM_GB}GB"
        echo "使用并行任务数: $JOBS"

    - name: Download all packages first
      run: |
        cd "$IMMORTAL_DIR"
        
        echo "下载所有需要的包..."
        make -j$JOBS download 2>&1 | tee download.log || {
          echo "并行下载失败，尝试单线程下载..."
          make -j1 download V=s 2>&1 | tee -a download.log
        }
        
        # 检查下载结果
        DOWNLOAD_OK_COUNT=$(find dl -name "*.ok" 2>/dev/null | wc -l)
        echo "已下载包数量: $DOWNLOAD_OK_COUNT"
        
        # 复制下载日志到工作空间
        cp download.log "$GITHUB_WORKSPACE/"

    - name: Compile firmware
      timeout-minutes: 160
      run: |
        cd "$IMMORTAL_DIR"
        
        # 设置必要的环境变量
        export FORCE_UNSAFE_CONFIGURE=1
        
        echo "开始编译固件..."
        echo "编译日志将保存到: $GITHUB_WORKSPACE/build_full.log"
        
        # 编译命令 - 使用 tee 同时输出到控制台和文件
        {
          echo "=== 编译开始于: $(date) ==="
          
          # 尝试并行编译
          if make -j$JOBS V=s 2>&1; then
            echo "=== 编译成功于: $(date) ==="
            COMPILE_SUCCESS=true
          else
            echo "=== 并行编译失败，尝试单线程编译 ==="
            COMPILE_SUCCESS=false
          fi
        } | tee "$GITHUB_WORKSPACE/build_full.log"
        
        # 如果并行编译失败，尝试单线程编译获取详细错误
        if [ "$COMPILE_SUCCESS" = "false" ]; then
          echo "开始单线程详细编译..."
          make -j1 V=sc 2>&1 | tee "$GITHUB_WORKSPACE/build_detailed.log"
          
          echo "编译失败，查看最后100行错误:"
          tail -100 "$GITHUB_WORKSPACE/build_detailed.log" | grep -i -A5 -B5 "error\|failed" || true
          
          echo "检查关键文件是否存在:"
          ls -la bin/targets/ 2>/dev/null || echo "bin/targets目录不存在"
          
          exit 1
        fi

    - name: Find and verify firmware
      run: |
        cd "$IMMORTAL_DIR"
        
        echo "查找生成的固件..."
        
        # 查找所有可能的固件文件
        FIRMWARE_FOUND=false
        
        for pattern in "*-ext4-combined.img.gz" "*-combined-ext4.img.gz" "*-squashfs-combined.img.gz" "*-combined.img.gz" "*.img.gz" "*.img"; do
          FILES=$(find bin -name "$pattern" -type f 2>/dev/null | head -5)
          if [ -n "$FILES" ]; then
            echo "找到文件 (模式: $pattern):"
            for file in $FILES; do
              echo "  - $file ($(du -h "$file" | cut -f1))"
              FIRMWARE_FOUND=true
            done
          fi
        done
        
        if [ "$FIRMWARE_FOUND" = "false" ]; then
          echo "❌ 未找到任何固件文件"
          echo "bin目录结构:"
          find bin -type f -name "*.img" -o -name "*.gz" -o -name "*.bin" 2>/dev/null | head -20 || true
          exit 1
        fi
        
        # 选择第一个找到的固件文件
        FIRMWARE_FILE=$(find bin -name "*.img.gz" -type f 2>/dev/null | head -1)
        if [ -z "$FIRMWARE_FILE" ]; then
          FIRMWARE_FILE=$(find bin -name "*.img" -type f 2>/dev/null | head -1)
        fi
        
        if [ -n "$FIRMWARE_FILE" ]; then
          echo "✅ 找到固件文件: $FIRMWARE_FILE"
          echo "文件大小: $(du -h "$FIRMWARE_FILE" | cut -f1)"
          
          # 复制到工作空间
          cp "$FIRMWARE_FILE" "$GITHUB_WORKSPACE/"
          FIRMWARE_BASENAME=$(basename "$FIRMWARE_FILE")
          echo "FIRMWARE_FILE=$GITHUB_WORKSPACE/$FIRMWARE_BASENAME" >> $GITHUB_ENV
          echo "FIRMWARE_BASENAME=$FIRMWARE_BASENAME" >> $GITHUB_ENV
        else
          echo "❌ 无法选择固件文件"
          exit 1
        fi

    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-firmware
        path: |
          ${{ env.IMMORTAL_DIR }}/bin/targets/
          $GITHUB_WORKSPACE/build-info.md
          $GITHUB_WORKSPACE/build_full.log
          $GITHUB_WORKSPACE/download.log
        retention-days: 30

    - name: Show build summary
      run: |
        echo "=== 构建总结 ==="
        echo "构建状态: ${{ job.status }}"
        echo "总构建时间: $((SECONDS / 3600))小时$(((SECONDS % 3600) / 60))分钟$((SECONDS % 60))秒"
        
        if [ -f "$GITHUB_WORKSPACE/build-info.md" ]; then
          echo "生成的文件:"
          cat "$GITHUB_WORKSPACE/build-info.md" | grep -A10 "生成文件"
        fi
        
        if [ -n "$FIRMWARE_FILE" ]; then
          echo "固件文件: $(basename "$FIRMWARE_FILE")"
          echo "文件位置: $GITHUB_WORKSPACE"
        fi
