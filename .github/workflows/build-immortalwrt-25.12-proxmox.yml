name: Build ImmortalWRT x86_64 with Proxmox Template

on:
  workflow_dispatch:
    inputs:
      use-local-config:
        description: '是否使用仓库里的 .config 文件？(yes/no)'
        required: true
        default: 'yes'
      enable-ccache:
        description: '是否启用编译缓存？(yes/no)'
        required: true
        default: 'yes'
      make-jobs:
        description: '并行编译任务数（0=自动）'
        required: true
        default: '0'
      clean-before-build:
        description: '编译前清理目录？(yes/no)'
        required: true
        default: 'yes'
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
    # ——————————————————————————————
    # 0. 构建开始通知
    # ——————————————————————————————
    - name: Build start notification
      run: |
        echo "🚀 ImmortalWRT x86_64 构建开始"
        echo "=========================================="
        echo "仓库: ${{ github.repository }}"
        echo "分支: ${{ github.ref_name }}"
        echo "提交: ${{ github.sha }}"
        echo "触发者: ${{ github.actor }}"
        echo "使用本地配置: ${{ github.event.inputs.use-local-config }}"
        echo "启用缓存: ${{ github.event.inputs.enable-ccache }}"
        echo "并行任务数: ${{ github.event.inputs.make-jobs }}"
        echo "=========================================="
        echo "::notice title=构建开始::ImmortalWRT x86_64 编译任务开始执行"

    # ——————————————————————————————
    # 1. 磁盘空间优化（必须第一位）
    # ——————————————————————————————
    - name: Free up disk space on runner
      uses: jlumbroso/free-disk-space@main
      with:
        # 基础清理
        tool-cache: true
        docker-images: true
        swap-storage: true
        # 开发环境清理
        android: true
        dotnet: true
        haskell: true
        large-packages: true
        # 扩展清理选项
        clean-cmake: true
        clean-gradle: true
        clean-maven: true
        clean-python: true
        clean-node: true
        # 系统清理
        clean-system: true
        remove-docs: true

    - name: Show initial disk status
      run: |
        echo "=== 初始磁盘状态 ==="
        df -h
        echo ""
        echo "=== 内存状态 ==="
        free -h
        echo ""
        echo "=== CPU信息 ==="
        nproc
        lscpu | grep -E "Model name|Core\(s\)|Thread\(s\)"

    # ——————————————————————————————
    # 2. 拉取仓库代码
    # ——————————————————————————————
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: recursive
        token: ${{ secrets.GITHUB_TOKEN }}

    # ——————————————————————————————
    # 3. 环境验证和依赖检查
    # ——————————————————————————————
    - name: Validate build environment
      run: |
        echo "=== 验证编译环境 ==="
        
        # 检查必要工具
        REQUIRED_TOOLS="gcc g++ make git wget curl python3 perl"
        MISSING_TOOLS=""
        
        for tool in $REQUIRED_TOOLS; do
          if ! command -v $tool >/dev/null 2>&1; then
            MISSING_TOOLS="$MISSING_TOOLS $tool"
          fi
        done
        
        if [ -n "$MISSING_TOOLS" ]; then
          echo "❌ 缺少必要的工具: $MISSING_TOOLS"
          exit 1
        else
          echo "✅ 所有必要工具已安装"
        fi
        
        # 检查磁盘空间（需要至少 20GB 可用）
        FREE_GB=$(df -BG . | awk 'NR==2 {print $4}' | sed 's/G//')
        if [ "$FREE_GB" -lt 20 ]; then
          echo "⚠️  警告：可用磁盘空间不足 20GB (当前: ${FREE_GB}GB)"
        else
          echo "✅ 磁盘空间充足: ${FREE_GB}GB"
        fi
        
        # 检查内存（需要至少 4GB）
        TOTAL_MEM_MB=$(free -m | awk 'NR==2 {print $2}')
        if [ "$TOTAL_MEM_MB" -lt 4096 ]; then
          echo "⚠️  警告：系统内存可能不足 (当前: ${TOTAL_MEM_MB}MB)"
        else
          echo "✅ 内存充足: ${TOTAL_MEM_MB}MB"
        fi

    # ——————————————————————————————
    # 4. 安装编译依赖
    # ——————————————————————————————
    - name: Install build dependencies
      run: |
        echo "=== 安装编译依赖 ==="
        
        # 更新包列表
        sudo apt-get update -y
        
        # 基础编译工具
        sudo apt-get install -y \
          build-essential \
          ccache \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          flex \
          gettext \
          libssl-dev \
          wget \
          unzip \
          rsync \
          python3 \
          python3-setuptools \
          python3-pip \
          subversion \
          file \
          bc \
          gcc-multilib \
          g++-multilib
        
        # 文件系统工具
        sudo apt-get install -y \
          squashfs-tools \
          dosfstools \
          mtools \
          e2fsprogs \
          parted \
          fdisk
        
        # 可选但有用的工具
        sudo apt-get install -y \
          jq \
          tree \
          pv \
          pigz \
          zstd
        
        # 显示安装的工具版本
        echo "=== 工具版本 ==="
        gcc --version | head -1
        make --version | head -1
        git --version | head -1
        python3 --version
        echo "依赖安装完成"

    # ——————————————————————————————
    # 5. 设置编译缓存
    # ——————————————————————————————
    - name: Setup ccache configuration
      if: ${{ github.event.inputs.enable-ccache == 'yes' }}
      run: |
        echo "=== 设置 ccache 缓存 ==="
        
        # 创建缓存目录
        mkdir -p ~/.ccache
        
        # 配置 ccache
        echo "max_size = 4.0G" > ~/.ccache/ccache.conf
        echo "compression = true" >> ~/.ccache/ccache.conf
        echo "compression_level = 1" >> ~/.ccache/ccache.conf
        echo "sloppiness = time_macros" >> ~/.ccache/ccache.conf
        
        # 设置环境变量
        echo "CCACHE_DIR=$(realpath ~/.ccache)" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=4G" >> $GITHUB_ENV
        echo "CCACHE_COMPRESS=1" >> $GITHUB_ENV
        
        # 显示缓存状态
        ccache --show-config
        ccache --show-stats
        
        echo "ccache 配置完成"

    # ——————————————————————————————
    # 6. 克隆 ImmortalWRT 源码
    # ——————————————————————————————
    - name: Clone ImmortalWRT source code
      run: |
        echo "=== 克隆 ImmortalWRT 源码 ==="
        
        # 设置克隆参数
        IMMORTAL_BRANCH="openwrt-25.12"
        IMMORTAL_URL="https://github.com/immortalwrt/immortalwrt.git"
        IMMORTAL_DIR="$GITHUB_WORKSPACE/immortal-src"
        
        echo "分支: $IMMORTAL_BRANCH"
        echo "URL: $IMMORTAL_URL"
        echo "目录: $IMMORTAL_DIR"
        
        # 清理现有目录（如果存在）
        if [ -d "$IMMORTAL_DIR" ] && [ "${{ github.event.inputs.clean-before-build }}" == "yes" ]; then
          echo "清理现有源码目录..."
          rm -rf "$IMMORTAL_DIR"
        fi
        
        # 克隆源码（带深度限制以加速）
        echo "正在克隆 ImmortalWRT..."
        git clone \
          --branch "$IMMORTAL_BRANCH" \
          --depth=50 \
          --single-branch \
          "$IMMORTAL_URL" \
          "$IMMORTAL_DIR"
        
        # 进入目录
        cd "$IMMORTAL_DIR"
        
        # 获取最新提交信息
        LATEST_COMMIT=$(git log -1 --format="%H - %s (%ci)")
        echo "最新提交: $LATEST_COMMIT"
        
        # 保存提交信息到环境变量
        echo "IMMORTAL_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
        echo "IMMORTAL_DIR=$IMMORTAL_DIR" >> $GITHUB_ENV
        
        echo "源码克隆完成"

    # ——————————————————————————————
    # 7. 应用本地配置
    # ——————————————————————————————
    - name: Apply custom configuration
      run: |
        echo "=== 应用配置文件 ==="
        cd "$IMMORTAL_DIR"
        
        CONFIG_SOURCE="$GITHUB_WORKSPACE/.config"
        CONFIG_TARGET=".config"
        
        if [ "${{ github.event.inputs.use-local-config }}" == "yes" ] && [ -f "$CONFIG_SOURCE" ]; then
          echo "使用仓库中的自定义配置..."
          cp -v "$CONFIG_SOURCE" "$CONFIG_TARGET"
          
          # 验证配置文件
          if grep -q "CONFIG_TARGET_x86_64=y" "$CONFIG_TARGET"; then
            echo "✅ 配置文件包含 x86_64 目标"
          else
            echo "⚠️  配置文件可能不是 x86_64 目标"
          fi
          
          # 显示配置摘要
          echo "=== 配置摘要 ==="
          grep -E "CONFIG_TARGET|CONFIG_BUSYBOX|CONFIG_PACKAGE" "$CONFIG_TARGET" | head -20
          
        else
          echo "使用默认配置..."
          if [ "${{ github.event.inputs.use-local-config }}" == "yes" ]; then
            echo "⚠️  未找到 .config 文件，使用默认配置"
          fi
        fi

    # ——————————————————————————————
    # 8. 更新和安装 feeds
    # ——————————————————————————————
    - name: Update and install feeds
      run: |
        echo "=== 更新软件源 (feeds) ==="
        cd "$IMMORTAL_DIR"
        
        # 显示当前 feeds 配置
        echo "Feeds 配置:"
        head -20 feeds.conf.default || cat feeds.conf
        
        # 更新 feeds
        echo "正在更新 feeds..."
        timeout 300 ./scripts/feeds update -a
        
        if [ $? -ne 0 ]; then
          echo "⚠️  Feeds 更新超时，尝试重试..."
          ./scripts/feeds update -a
        fi
        
        # 安装 feeds
        echo "正在安装 feeds..."
        ./scripts/feeds install -a
        
        # 显示已安装的包数量
        echo "Feeds 更新完成"
        find ./package/feeds -name "Makefile" | wc -l | xargs echo "可用包数量: "

    # ——————————————————————————————
    # 9. 生成默认配置（如果没有自定义配置）
    # ——————————————————————————————
    - name: Generate default configuration
      if: ${{ github.event.inputs.use-local-config == 'no' }}
      run: |
        echo "=== 生成默认配置 ==="
        cd "$IMMORTAL_DIR"
        
        # 生成默认配置
        make defconfig
        
        # 显示生成的配置
        echo "生成的配置摘要:"
        grep "CONFIG_TARGET" .config
        grep "CONFIG_BUSYBOX" .config | head -5
        
        echo "默认配置生成完成"

    # ——————————————————————————————
     # 10. 显示编译前状态
    # ——————————————————————————————
    - name: Show pre-build status
      run: |
        echo "=== 编译前状态检查 ==="
        cd "$IMMORTAL_DIR"
        
        # 磁盘使用情况
        echo "磁盘使用情况:"
        df -h .
        
        # 源码目录大小
        echo "源码目录大小:"
        du -sh . || echo "无法计算目录大小"
        
        # 缓存状态
        if [ "${{ github.event.inputs.enable-ccache }}" == "yes" ]; then
          echo "ccache 统计:"
          ccache --show-stats
        fi
        
        # 计算并行任务数
        if [ "${{ github.event.inputs.make-jobs }}" == "0" ]; then
          JOBS=$(( $(nproc) + 1 ))
        else
          JOBS=${{ github.event.inputs.make-jobs }}
        fi
        echo "将使用 $JOBS 个并行任务"
        echo "JOBS=$JOBS" >> $GITHUB_ENV
        
        echo "状态检查完成"

    # ——————————————————————————————
    # 11. 编译 ImmortalWRT
    # ——————————————————————————————
    - name: Compile ImmortalWRT firmware
      timeout-minutes: 180
      run: |
        echo "=== 开始编译 ImmortalWRT ==="
        cd "$IMMORTAL_DIR"
        
        # 设置编译环境
        export FORCE_UNSAFE_CONFIGURE=1
        
        # 确定并行任务数
        if [ -z "$JOBS" ]; then
          if [ "${{ github.event.inputs.make-jobs }}" == "0" ]; then
            JOBS=$(( $(nproc) + 1 ))
          else
            JOBS=${{ github.event.inputs.make-jobs }}
          fi
        fi
        
        echo "使用 $JOBS 个并行编译任务"
        echo "编译开始时间: $(date)"
        
        # 编译固件（根据是否有缓存选择策略）
        if [ "${{ github.event.inputs.enable-ccache }}" == "yes" ]; then
          echo "使用 ccache 加速编译..."
          make -j$JOBS V=s 2>&1 | tee build.log || {
            echo "并行编译失败，尝试单线程编译..."
            make V=sc 2>&1 | tee -a build.log
          }
        else
          echo "不使用 ccache..."
          make -j$JOBS V=s 2>&1 | tee build.log
        fi
        
        # 检查编译结果
        if [ -f "bin/targets/x86/64/config.buildinfo" ]; then
          echo "✅ 编译成功完成"
          echo "编译结束时间: $(date)"
          
          # 保存编译日志
          cp build.log "$GITHUB_WORKSPACE/build.log"
        else
          echo "❌ 编译可能失败，检查日志"
          echo "编译结束时间: $(date)"
          exit 1
        fi

    # ——————————————————————————————
    # 12. 生成 Proxmox LXC 根文件系统模板
    # ——————————————————————————————
    - name: Generate Proxmox LXC rootfs template
      run: |
        echo "=== 生成 Proxmox LXC 模板 ==="
        
        cd "$IMMORTAL_DIR/bin/targets/x86/64"
        
        # 查找根文件系统镜像
        echo "查找根文件系统镜像..."
        ROOT_IMG=$(find . -name "*-ext4-rootfs.img" -o -name "*-rootfs.img" -o -name "*-combined-ext4.img" | head -1)
        
        if [ -z "$ROOT_IMG" ]; then
          echo "❌ 未找到根文件系统镜像"
          ls -la .
          exit 1
        fi
        
        echo "使用镜像: $ROOT_IMG"
        
        # 创建临时工作目录
        TEMP_DIR=$(mktemp -d)
        MOUNT_DIR="$TEMP_DIR/mnt"
        ROOTFS_DIR="$TEMP_DIR/rootfs"
        
        mkdir -p "$MOUNT_DIR" "$ROOTFS_DIR"
        
        # 挂载镜像并复制文件
        echo "挂载镜像..."
        sudo mount -o loop,ro "$ROOT_IMG" "$MOUNT_DIR"
        
        echo "复制文件系统..."
        sudo rsync -a "$MOUNT_DIR"/ "$ROOTFS_DIR"/
        
        echo "卸载镜像..."
        sudo umount "$MOUNT_DIR"
        
        # 清理不必要的文件以减小体积
        echo "清理临时文件..."
        sudo rm -rf "$ROOTFS_DIR"/tmp/*
        sudo rm -rf "$ROOTFS_DIR"/var/log/*
        sudo rm -rf "$ROOTFS_DIR"/var/tmp/*
        sudo rm -rf "$ROOTFS_DIR"/root/.bash_history 2>/dev/null || true
        
        # 创建 Proxmox LXC 所需文件
        echo "创建 Proxmox LXC 配置文件..."
        cat > "$TEMP_DIR/lxc.conf" << EOF
arch: amd64
cores: 2
hostname: openwrt
memory: 512
net0: name=eth0,bridge=vmbr0,firewall=1,hwaddr=52:53:54:00:00:01,ip=dhcp,type=veth
ostype: unmanaged
rootfs: local-lvm:vm-100-disk-0,size=2G
swap: 512
lxc.cgroup.devices.allow: c 108:0 rwm
lxc.cgroup.devices.allow: c 10:200 rwm
lxc.mount.entry: /dev/net/tun dev/net/tun none bind,create=file
lxc.mount.entry: /dev/dri dev/dri none bind,optional,create=dir
EOF
        
        # 打包根文件系统（使用高效压缩）
        echo "打包根文件系统..."
        cd "$ROOTFS_DIR"
        sudo tar --numeric-owner \
          --xattrs \
          --xattrs-include='*' \
          --exclude='./dev/*' \
          --exclude='./proc/*' \
          --exclude='./sys/*' \
          --exclude='./tmp/*' \
          -c . | pigz -9 > "$GITHUB_WORKSPACE/openwrt-x86-64-rootfs.tar.gz"
        
        # 生成元数据文件
        echo "创建元数据文件..."
        cat > "$GITHUB_WORKSPACE/metadata.yaml" << EOF
template_name: immortalwrt-x86-64
template_version: $(date +%Y%m%d)
source_commit: ${{ env.IMMORTAL_COMMIT }}
build_date: $(date -Iseconds)
compression: gzip-9
rootfs_size: $(du -sh $ROOTFS_DIR | cut -f1)
proxmox_compatible: true
architecture: x86_64
kernel_version: $(find $ROOTFS_DIR/lib/modules -maxdepth 1 -type d -name "*" 2>/dev/null | head -1 | xargs basename)
packages_installed: $(find $ROOTFS_DIR/usr/lib/opkg/info -name "*.control" 2>/dev/null | wc -l)
EOF
        
        # 清理临时目录
        echo "清理临时文件..."
        sudo rm -rf "$TEMP_DIR"
        
        # 显示结果
        echo "模板生成完成:"
        ls -lh "$GITHUB_WORKSPACE/openwrt-x86-64-rootfs.tar.gz"

    # ——————————————————————————————
    # 13. 收集编译产物信息
    # ——————————————————————————————
    - name: Collect build artifacts information
      run: |
        echo "=== 编译产物信息 ==="
        
        BUILD_DIR="$IMMORTAL_DIR/bin/targets/x86/64"
        OUTPUT_DIR="$GITHUB_WORKSPACE/build-output"
        
        mkdir -p "$OUTPUT_DIR"
        
        # 查找所有镜像文件
        echo "固件镜像:"
        find "$BUILD_DIR" -name "*.img" -type f | while read img; do
          SIZE=$(du -h "$img" | cut -f1)
          echo "  - $(basename "$img") ($SIZE)"
          cp "$img" "$OUTPUT_DIR/"
        done
        
        # 查找内核文件
        echo "内核文件:"
        find "$BUILD_DIR" -name "*-kernel*" -type f | while read kernel; do
          echo "  - $(basename "$kernel")"
          cp "$kernel" "$OUTPUT_DIR/"
        done
        
        # 统计包数量
        PKG_COUNT=$(find "$BUILD_DIR/packages" -name "*.ipk" -type f 2>/dev/null | wc -l || echo "0")
        echo "软件包数量: $PKG_COUNT"
        
        # 生成文件清单
        find "$BUILD_DIR" -type f -name "*" | sort > "$OUTPUT_DIR/filelist.txt"
        
        # 生成 SHA256 校验和
        cd "$OUTPUT_DIR"
        sha256sum * > SHA256SUMS 2>/dev/null || true
        
        # 显示最终目录结构
        echo "最终输出目录内容:"
        tree "$OUTPUT_DIR" -L 2 || ls -la "$OUTPUT_DIR"

    # ——————————————————————————————
    # 14. 创建构建信息文件
    # ——————————————————————————————
    - name: Create build information file
      run: |
        echo "=== 创建构建信息 ==="
        
        BUILD_INFO="$GITHUB_WORKSPACE/build-info.md"
        
        cat > "$BUILD_INFO" << EOF
# ImmortalWRT x86_64 构建报告

## 构建信息
- **构建时间**: $(date)
- **构建ID**: ${{ github.run_id }}-${{ github.run_attempt }}
- **仓库**: ${{ github.repository }}
- **分支**: ${{ github.ref_name }}
- **提交**: ${{ github.sha }}
- **触发者**: ${{ github.actor }}

## 编译配置
- **使用本地配置**: ${{ github.event.inputs.use-local-config }}
- **启用ccache**: ${{ github.event.inputs.enable-ccache }}
- **并行任务数**: ${{ github.event.inputs.make-jobs }}
- **清理目录**: ${{ github.event.inputs.clean-before-build }}

## 源码信息
- **ImmortalWRT分支**: openwrt-25.12
- **源码提交**: ${{ env.IMMORTAL_COMMIT }}

## 系统信息
- **运行环境**: ${{ runner.os }} (${{ runner.arch }})
- **CPU核心**: $(nproc)
- **构建时间**: $(date -d "@$SECONDS" -u +%H:%M:%S)

## 产物信息
EOF
        
        # 添加文件列表
        echo "## 生成的文件" >> "$BUILD_INFO"
        find "$GITHUB_WORKSPACE" -maxdepth 1 -name "*.tar.gz" -o -name "*.img" -o -name "*.log" | while read file; do
          SIZE=$(du -h "$file" | cut -f1)
          echo "- $(basename "$file") ($SIZE)" >> "$BUILD_INFO"
        done
        
        echo "构建信息文件已创建"
        cat "$BUILD_INFO"

    # ——————————————————————————————
    # 15. 显示编译缓存统计
    # ——————————————————————————————
    - name: Show ccache statistics
      if: ${{ github.event.inputs.enable-ccache == 'yes' }}
      run: |
        echo "=== ccache 统计 ==="
        ccache --show-stats
        
        # 计算缓存命中率
        HITS=$(ccache --show-stats | grep "cache hit" | head -1 | awk '{print $4}')
        MISSES=$(ccache --show-stats | grep "cache miss" | head -1 | awk '{print $4}')
        
        if [ "$HITS" -gt 0 ] || [ "$MISSES" -gt 0 ]; then
          TOTAL=$((HITS + MISSES))
          if [ $TOTAL -gt 0 ]; then
            HIT_RATE=$((HITS * 100 / TOTAL))
            echo "缓存命中率: $HIT_RATE% ($HITS/$TOTAL)"
          fi
        fi

    # ——————————————————————————————
    # 16. 上传构建产物
    # ——————————————————————————————
    - name: Upload firmware artifacts
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-x86-64-firmware
        path: |
          ${{ env.IMMORTAL_DIR }}/bin/targets/x86/64/*.img
          ${{ env.IMMORTAL_DIR }}/bin/targets/x86/64/*.gz
          ${{ env.IMMORTAL_DIR }}/bin/targets/x86/64/*.bin
          ${{ env.IMMORTAL_DIR }}/bin/targets/x86/64/packages/
        compression-level: 6
        retention-days: 30

    - name: Upload Proxmox template
      uses: actions/upload-artifact@v4
      with:
        name: proxmox-lxc-template
        path: |
          $GITHUB_WORKSPACE/openwrt-x86-64-rootfs.tar.gz
          $GITHUB_WORKSPACE/metadata.yaml
          $GITHUB_WORKSPACE/build-info.md
        compression-level: 1  # 已经是压缩文件
        retention-days: 30

    - name: Upload build logs and info
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-and-info
        path: |
          $GITHUB_WORKSPACE/build.log
          $GITHUB_WORKSPACE/build-output/
        retention-days: 7

    # ——————————————————————————————
    # 17. 显示最终磁盘状态
    # ——————————————————————————————
    - name: Show final disk status
      run: |
        echo "=== 最终磁盘状态 ==="
        df -h
        
        echo ""
        echo "=== 构建目录大小 ==="
        du -sh $GITHUB_WORKSPACE/* 2>/dev/null | sort -hr || true
        
        echo ""
        echo "=== 总构建时间 ==="
        echo "$((SECONDS / 3600))小时$(((SECONDS % 3600) / 60))分钟$((SECONDS % 60))秒"

    # ——————————————————————————————
    # 18. 构建完成通知
    # ——————————————————————————————
    - name: Build completion notification
      if: always()
      run: |
        echo "=== 构建完成 ==="
        
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ 构建成功完成！"
          echo "::notice title=构建成功::ImmortalWRT x86_64 编译成功"
          
          # 显示产物摘要
          echo "生成的产物："
          ls -lh $GITHUB_WORKSPACE/*.tar.gz $GITHUB_WORKSPACE/*.md 2>/dev/null || true
        else
          echo "❌ 构建失败"
          echo "::error title=构建失败::ImmortalWRT x86_64 编译失败"
        fi

    # ——————————————————————————————
    # 19. 清理工作空间（可选）
    # ——————————————————————————————
    - name: Clean up workspace
      if: always()
      run: |
        echo "=== 清理工作空间 ==="
        
        # 保留日志和产物，清理源码
        if [ -d "${{ env.IMMORTAL_DIR }}" ]; then
          echo "清理源码目录..."
          rm -rf "${{ env.IMMORTAL_DIR }}"
        fi
        
        # 清理临时文件
        echo "清理临时文件..."
        sudo rm -rf /tmp/*
        sudo rm -rf /var/tmp/*
        
        # 清理包缓存
        echo "清理包缓存..."
        sudo apt-get clean
        
        echo "清理完成"
