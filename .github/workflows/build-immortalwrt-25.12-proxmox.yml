name: Build ImmortalWRT x86_64 with Proxmox Template

on:
  workflow_dispatch:
    inputs:
      use-local-config:
        description: '是否使用仓库里的 .config 文件？(yes/no)'
        required: true
        default: 'yes'
      enable-ccache:
        description: '是否启用编译缓存？(yes/no)'
        required: true
        default: 'yes'
      make-jobs:
        description: '并行编译任务数（0=自动）'
        required: true
        default: '0'
      clean-before-build:
        description: '编译前清理目录？(yes/no)'
        required: true
        default: 'yes'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240
    
    steps:
    - name: Free up disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        docker-images: true
        swap-storage: true
        android: true
        dotnet: true
        large-packages: true

    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Validate build environment
      run: |
        REQUIRED_TOOLS="gcc g++ make git wget curl python3 perl"
        for tool in $REQUIRED_TOOLS; do
          if ! command -v $tool >/dev/null 2>&1; then
            echo "❌ 缺少工具: $tool"
            exit 1
          fi
        done
        
        FREE_GB=$(df -BG . | awk 'NR==2 {print $4}' | sed 's/G//')
        if [ "$FREE_GB" -lt 20 ]; then
          echo "⚠️ 磁盘空间不足: ${FREE_GB}GB"
        fi

    - name: Install build dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential \
          ccache \
          libncurses5-dev \
          libncursesw5-dev \
          zlib1g-dev \
          gawk \
          flex \
          gettext \
          libssl-dev \
          wget \
          unzip \
          python3 \
          python3-setuptools \
          subversion \
          file \
          bc \
          squashfs-tools \
          dosfstools

    - name: Setup ccache
      if: ${{ github.event.inputs.enable-ccache == 'yes' }}
      run: |
        mkdir -p ~/.ccache
        echo "max_size = 4.0G" > ~/.ccache/ccache.conf
        echo "CCACHE_DIR=$(realpath ~/.ccache)" >> $GITHUB_ENV
        echo "CCACHE_MAXSIZE=4G" >> $GITHUB_ENV

    - name: Clone ImmortalWRT source
      run: |
        IMMORTAL_DIR="$GITHUB_WORKSPACE/immortal-src"
        
        if [ -d "$IMMORTAL_DIR" ] && [ "${{ github.event.inputs.clean-before-build }}" == "yes" ]; then
          rm -rf "$IMMORTAL_DIR"
        fi
        
        git clone --branch openwrt-25.12 --depth=50 --single-branch \
          https://github.com/immortalwrt/immortalwrt.git "$IMMORTAL_DIR"
        
        cd "$IMMORTAL_DIR"
        LATEST_COMMIT=$(git log -1 --format="%H - %s (%ci)")
        echo "IMMORTAL_COMMIT=$LATEST_COMMIT" >> $GITHUB_ENV
        echo "IMMORTAL_DIR=$IMMORTAL_DIR" >> $GITHUB_ENV

    - name: Apply custom configuration
      run: |
        cd "$IMMORTAL_DIR"
        
        CONFIG_SOURCE="$GITHUB_WORKSPACE/.config"
        CONFIG_TARGET=".config"
        
        if [ "${{ github.event.inputs.use-local-config }}" == "yes" ] && [ -f "$CONFIG_SOURCE" ]; then
          cp -v "$CONFIG_SOURCE" "$CONFIG_TARGET"
          echo "使用自定义配置"
        else
          echo "使用默认配置"
        fi

    - name: Update feeds
      run: |
        cd "$IMMORTAL_DIR"
        timeout 300 ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Generate default config
      if: ${{ github.event.inputs.use-local-config == 'no' }}
      run: |
        cd "$IMMORTAL_DIR"
        make defconfig

    - name: Calculate job count
      run: |
        if [ "${{ github.event.inputs.make-jobs }}" == "0" ]; then
          JOBS=$(( $(nproc) + 1 ))
        else
          JOBS=${{ github.event.inputs.make-jobs }}
        fi
        echo "JOBS=$JOBS" >> $GITHUB_ENV
        echo "并行任务数: $JOBS"

    - name: Compile firmware
      timeout-minutes: 180
      run: |
        cd "$IMMORTAL_DIR"
        export FORCE_UNSAFE_CONFIGURE=1
        
        echo "开始编译固件..."
        if [ "${{ github.event.inputs.enable-ccache }}" == "yes" ]; then
          make -j$JOBS V=s 2>&1 | tee build.log || make V=sc 2>&1 | tee -a build.log
        else
          make -j$JOBS V=s 2>&1 | tee build.log
        fi
        
        echo "编译完成，检查生成的文件..."
        ls -la bin/targets/x86/64/
        
        if ls bin/targets/x86/64/*.img 2>/dev/null; then
          echo "✅ 编译成功"
          cp build.log "$GITHUB_WORKSPACE/build.log"
        else
          echo "❌ 编译失败，未找到固件镜像"
          exit 1
        fi

    - name: Generate Proxmox template
      run: |
        echo "进入编译输出目录..."
        cd "$IMMORTAL_DIR/bin/targets/x86/64"
        
        echo "列出所有文件:"
        ls -la
        
        echo "寻找根文件系统镜像..."
        # 尝试多种可能的文件名模式
        if ls *-ext4-rootfs.img* 2>/dev/null; then
          ROOT_IMG=$(ls *-ext4-rootfs.img* | head -1)
          echo "找到镜像: $ROOT_IMG"
        elif ls *-combined-ext4.img* 2>/dev/null; then
          ROOT_IMG=$(ls *-combined-ext4.img* | head -1)
          echo "找到镜像: $ROOT_IMG"
        elif ls *-rootfs.img* 2>/dev/null; then
          ROOT_IMG=$(ls *-rootfs.img* | head -1)
          echo "找到镜像: $ROOT_IMG"
        else
          echo "未找到根文件系统镜像，尝试列出所有img文件..."
          ls *.img* 2>/dev/null || echo "没有找到任何img文件"
          echo "尝试使用磁盘镜像..."
          # 尝试使用磁盘镜像（通常包含根文件系统分区）
          DISK_IMG=$(ls *-combined.img* | head -1)
          if [ -n "$DISK_IMG" ]; then
            echo "使用磁盘镜像: $DISK_IMG"
            ROOT_IMG="$DISK_IMG"
          else
            echo "❌ 未找到任何可用的镜像文件"
            exit 1
          fi
        fi
        
        # 检查镜像是否压缩
        if [[ "$ROOT_IMG" == *.gz ]]; then
          echo "镜像被压缩，正在解压..."
          gunzip "$ROOT_IMG"
          ROOT_IMG="${ROOT_IMG%.gz}"
        fi
        
        if [[ "$ROOT_IMG" == *.img ]]; then
          echo "开始生成Proxmox模板..."
          
          TEMP_DIR=$(mktemp -d)
          MOUNT_DIR="$TEMP_DIR/mnt"
          ROOTFS_DIR="$TEMP_DIR/rootfs"
          
          mkdir -p "$MOUNT_DIR" "$ROOTFS_DIR"
          
          echo "挂载镜像: $ROOT_IMG"
          sudo mount -o loop,ro "$ROOT_IMG" "$MOUNT_DIR"
          
          echo "复制文件系统..."
          sudo rsync -a "$MOUNT_DIR"/ "$ROOTFS_DIR"/
          
          echo "卸载镜像..."
          sudo umount "$MOUNT_DIR"
          
          echo "清理临时文件..."
          sudo rm -rf "$ROOTFS_DIR"/tmp/*
          sudo rm -rf "$ROOTFS_DIR"/var/log/*
          
          echo "打包根文件系统..."
          cd "$ROOTFS_DIR"
          sudo tar --numeric-owner --xattrs -c . | gzip -9 > "$GITHUB_WORKSPACE/openwrt-x86-64-rootfs.tar.gz"
          
          echo "清理临时目录..."
          sudo rm -rf "$TEMP_DIR"
          
          echo "模板生成完成: $(du -h $GITHUB_WORKSPACE/openwrt-x86-64-rootfs.tar.gz | cut -f1)"
        else
          echo "❌ 文件不是img格式: $ROOT_IMG"
          exit 1
        fi

    - name: Create build info
      run: |
        BUILD_INFO="$GITHUB_WORKSPACE/build-info.md"
        
        echo "# ImmortalWRT 构建报告" > "$BUILD_INFO"
        echo "" >> "$BUILD_INFO"
        echo "## 构建信息" >> "$BUILD_INFO"
        echo "- **时间**: $(date)" >> "$BUILD_INFO"
        echo "- **构建ID**: ${{ github.run_id }}-${{ github.run_attempt }}" >> "$BUILD_INFO"
        echo "- **提交**: ${{ github.sha }}" >> "$BUILD_INFO"
        echo "- **触发者**: ${{ github.actor }}" >> "$BUILD_INFO"
        echo "" >> "$BUILD_INFO"
        echo "## 配置" >> "$BUILD_INFO"
        echo "- **本地配置**: ${{ github.event.inputs.use-local-config }}" >> "$BUILD_INFO"
        echo "- **启用缓存**: ${{ github.event.inputs.enable-ccache }}" >> "$BUILD_INFO"
        echo "- **并行任务**: ${{ github.event.inputs.make-jobs }}" >> "$BUILD_INFO"
        echo "" >> "$BUILD_INFO"
        echo "## 源码信息" >> "$BUILD_INFO"
        echo "- **分支**: openwrt-25.12" >> "$BUILD_INFO"
        echo "- **提交**: ${{ env.IMMORTAL_COMMIT }}" >> "$BUILD_INFO"
        echo "" >> "$BUILD_INFO"
        echo "## 生成文件" >> "$BUILD_INFO"
        
        find "$GITHUB_WORKSPACE" -maxdepth 1 -name "*.tar.gz" -o -name "*.img" | while read file; do
          SIZE=$(du -h "$file" | cut -f1)
          echo "- $(basename "$file") ($SIZE)" >> "$BUILD_INFO"
        done

    - name: Upload firmware
      uses: actions/upload-artifact@v4
      with:
        name: immortalwrt-x86-64-firmware
        path: |
          ${{ env.IMMORTAL_DIR }}/bin/targets/x86/64/*.img
          ${{ env.IMMORTAL_DIR }}/bin/targets/x86/64/*.gz
          ${{ env.IMMORTAL_DIR }}/bin/targets/x86/64/packages/
        retention-days: 30

    - name: Upload Proxmox template
      uses: actions/upload-artifact@v4
      with:
        name: proxmox-lxc-template
        path: |
          $GITHUB_WORKSPACE/openwrt-x86-64-rootfs.tar.gz
          $GITHUB_WORKSPACE/build-info.md
        retention-days: 30

    - name: Show build time
      run: |
        echo "总构建时间: $((SECONDS / 3600))小时$(((SECONDS % 3600) / 60))分钟$((SECONDS % 60))秒"
