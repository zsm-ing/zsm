name: Build OpenWrt / ImmortalWRT 25.12 LXC Rootfs

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'é€‰æ‹©æºç '
        required: true
        default: 'immortalwrt'
        type: choice
        options:
          - immortalwrt
          - openwrt
      use-local-config:
        description: 'ä½¿ç”¨ä»“åº“ä¸­çš„ .configï¼Ÿ'
        required: true
        default: 'yes'

permissions:
  contents: write

concurrency:
  group: wrt-lxc
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential gawk flex gettext \
            libncurses5-dev libncursesw5-dev zlib1g-dev \
            libssl-dev wget unzip python3 python3-setuptools \
            rsync subversion file bc tar ccache
          echo "CCACHE_DIR=$RUNNER_TEMP/ccache" >> $GITHUB_ENV
          ccache -M 5G
          ccache -s

      - name: Clone OpenWrt / ImmortalWRT
        run: |
          mkdir -p src
          if [ "${{ github.event.inputs.source }}" = "openwrt" ]; then
            echo "ðŸ‘‰ ä½¿ç”¨ OpenWrt å®˜æ–¹ 25.12"
            git clone --depth=50 --branch openwrt-25.12 \
              https://github.com/openwrt/openwrt.git src/openwrt
            echo "WRT_DIR=$GITHUB_WORKSPACE/src/openwrt" >> $GITHUB_ENV
            echo "WRT_NAME=OpenWrt" >> $GITHUB_ENV
          else
            echo "ðŸ‘‰ ä½¿ç”¨ ImmortalWRT 25.12"
            git clone --depth=50 --branch openwrt-25.12 \
              https://github.com/immortalwrt/immortalwrt.git src/immortalwrt
            echo "WRT_DIR=$GITHUB_WORKSPACE/src/immortalwrt" >> $GITHUB_ENV
            echo "WRT_NAME=ImmortalWRT" >> $GITHUB_ENV
          fi

      - name: Restore build cache
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.WRT_DIR }}/dl
            ${{ env.WRT_DIR }}/build_dir
            ${{ env.WRT_DIR }}/staging_dir
          key: wrt-${{ github.event.inputs.source }}-${{ runner.os }}-${{ hashFiles('.config') }}
          restore-keys: |
            wrt-${{ github.event.inputs.source }}-${{ runner.os }}-

      - name: Update & install feeds
        run: |
          cd $WRT_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply custom .config
        if: ${{ github.event.inputs.use-local-config == 'yes' }}
        run: |
          cd $WRT_DIR
          test -f $GITHUB_WORKSPACE/.config || {
            echo "âŒ ä»“åº“ä¸­æœªæ‰¾åˆ° .config"
            exit 1
          }
          cp $GITHUB_WORKSPACE/.config .config

      - name: Defconfig (lock config)
        run: |
          cd $WRT_DIR
          make defconfig
          echo "===== TARGET CHECK ====="
          grep -E "CONFIG_TARGET_x86_64|CONFIG_TARGET_ROOTFS_TARGZ" .config

      - name: Apply DIY customizations
        run: |
          cd $WRT_DIR
          test -f $GITHUB_WORKSPACE/diy.sh || {
            echo "âŒ æœªæ‰¾åˆ° diy.sh"
            exit 1
          }
          cp $GITHUB_WORKSPACE/diy.sh .
          chmod +x diy.sh
          ./diy.sh

      - name: Compile world (LXC rootfs)
        run: |
          cd $WRT_DIR
          make -j$(nproc) world V=s > build.log 2>&1 || {
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œæœ€åŽ 100 è¡Œæ—¥å¿—ï¼š"
            tail -n 100 build.log
            exit 1
          }

      - name: Collect rootfs
        run: |
          cd $WRT_DIR
          find bin/targets -type f
          ROOTFS=$(find bin/targets -name "*rootfs.tar.gz" | head -n1)
          [ -n "$ROOTFS" ] || {
            echo "âŒ æœªç”Ÿæˆ rootfs.tar.gz"
            exit 1
          }
          echo "ROOTFS=$ROOTFS" >> $GITHUB_ENV

      - name: Set release metadata
        run: |
          cd $WRT_DIR
          echo "WRT_COMMIT=$(git log -1 --format=%h)" >> $GITHUB_ENV
          echo "WRT_VERSION=$(git describe --tags --always)" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV

      - name: Release LXC rootfs
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.WRT_NAME }}-lxc-${{ env.WRT_VERSION }}-${{ env.BUILD_DATE }}
          name: ${{ env.WRT_NAME }} 25.12 LXC Rootfs
          body: |
            è‡ªåŠ¨æž„å»ºçš„ ${{ env.WRT_NAME }} 25.12 LXC Rootfs

            Source: ${{ github.event.inputs.source }}
            Commit: ${{ env.WRT_COMMIT }}
            Version: ${{ env.WRT_VERSION }}
            Date: ${{ env.BUILD_DATE }}

          files: |
            ${{ env.WRT_DIR }}/bin/targets/**/sha256sums
            ${{ env.WRT_DIR }}/bin/targets/**/*rootfs.tar.gz
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
