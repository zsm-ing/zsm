name: Build ImmortalWRT LXC Rootfs

on:
  workflow_dispatch:
    inputs:
      use-local-config:
        description: '使用仓库中的 .config？'
        required: true
        default: 'yes'

permissions:
  contents: write

concurrency:
  group: immortalwrt-lxc
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential gawk flex gettext \
            libncurses5-dev libncursesw5-dev zlib1g-dev \
            libssl-dev wget unzip python3 python3-setuptools \
            rsync subversion file bc tar ccache
          ccache -M 5G
          echo "CCACHE_DIR=$RUNNER_TEMP/ccache" >> $GITHUB_ENV

      - name: Clone ImmortalWRT
        run: |
          git clone --depth=50 --branch openwrt-25.12 \
            https://github.com/immortalwrt/immortalwrt.git immortalwrt
          echo "IMMORTAL_DIR=$GITHUB_WORKSPACE/immortalwrt" >> $GITHUB_ENV

      - name: Restore build cache
        uses: actions/cache@v3
        with:
          path: |
            immortalwrt/dl
            immortalwrt/build_dir
            immortalwrt/staging_dir
            immortalwrt/feeds
          key: immortalwrt-${{ github.sha }}
          restore-keys: |
            immortalwrt-

      - name: Apply custom config
        if: ${{ github.event.inputs.use-local-config == 'yes' }}
        run: |
          cd $IMMORTAL_DIR
          test -f $GITHUB_WORKSPACE/.config || { echo "❌ .config 不存在"; exit 1; }
          cp $GITHUB_WORKSPACE/.config .config

      # ===== 方法 3：feeds → defconfig → world =====
      - name: Update feeds & defconfig
        run: |
          cd $IMMORTAL_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          make defconfig

      - name: Compile world (LXC rootfs)
        run: |
          cd $IMMORTAL_DIR
          make -j$(nproc) world V=s > build.log 2>&1 || {
            echo "❌ 编译失败，最后 100 行日志："
            tail -n 100 build.log
            exit 1
          }

      - name: Collect rootfs
        run: |
          cd $IMMORTAL_DIR
          ROOTFS=$(find bin/targets -name "*rootfs.tar.gz" | head -n1)
          [ -n "$ROOTFS" ] || { echo "❌ 未生成 rootfs"; exit 1; }
          echo "ROOTFS=$ROOTFS" >> $GITHUB_ENV

      - name: Set release metadata
        run: |
          cd $IMMORTAL_DIR
          echo "IMMORTAL_COMMIT=$(git log -1 --format=%h)" >> $GITHUB_ENV
          echo "IMMORTAL_VERSION=$(git describe --tags --always)" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV

      - name: Delete old releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 1
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release LXC rootfs
        uses: softprops/action-gh-release@v2
        with:
          tag_name: immortalwrt-lxc-${{ env.IMMORTAL_VERSION }}-${{ env.BUILD_DATE }}
          name: ImmortalWRT LXC Rootfs
          body: |
            自动构建的 ImmortalWRT LXC rootfs

            Commit: ${{ env.IMMORTAL_COMMIT }}
            Version: ${{ env.IMMORTAL_VERSION }}
            Date: ${{ env.BUILD_DATE }}
          files: ${{ env.ROOTFS }}
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
