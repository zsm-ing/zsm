name: Build ImmortalWRT LXC Rootfs (Advanced)

on:
  workflow_dispatch:
    inputs:
      use-local-config:
        description: '使用仓库中的 .config？'
        required: true
        default: 'yes'

permissions:
  contents: write

concurrency:
  group: immortalwrt-lxc
  cancel-in-progress: true

jobs:
  setup:
    name: Setup Build Environment
    runs-on: ubuntu-22.04
    outputs:
      immortal_dir: ${{ steps.set-path.outputs.immortal_dir }}
      immortal_version: ${{ steps.set-path.outputs.immortal_version }}
      immortal_commit: ${{ steps.set-path.outputs.immortal_commit }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential gawk flex gettext \
            libncurses5-dev libncursesw5-dev zlib1g-dev \
            libssl-dev wget unzip python3 python3-setuptools \
            rsync subversion file bc tar ccache
          ccache -M 5G
          export CCACHE_DIR="$RUNNER_TEMP/ccache"
          echo "CCACHE_DIR=$CCACHE_DIR" >> $GITHUB_ENV

      - name: Clone ImmortalWRT
        id: set-path
        run: |
          git clone --depth=50 --branch openwrt-25.12 \
            https://github.com/immortalwrt/immortalwrt.git immortalwrt
          cd immortalwrt
          IMMORTAL_COMMIT=$(git log -1 --format=%h)
          IMMORTAL_VERSION=$(git describe --tags --always)
          echo "immortal_dir=$PWD" >> $GITHUB_OUTPUT
          echo "immortal_commit=$IMMORTAL_COMMIT" >> $GITHUB_OUTPUT
          echo "immortal_version=$IMMORTAL_VERSION" >> $GITHUB_OUTPUT

      - name: Cache downloads & feeds
        uses: actions/cache@v3
        with:
          path: |
            immortalwrt/downloads
            immortalwrt/feeds
          key: downloads-feeds-${{ github.sha }}
          restore-keys: |
            downloads-feeds-

  update_feeds:
    name: Update Feeds
    runs-on: ubuntu-22.04
    needs: setup
    steps:
      - uses: actions/checkout@v4
      - name: Restore cached feeds
        uses: actions/cache@v3
        with:
          path: ${{ needs.setup.outputs.immortal_dir }}/feeds
          key: feeds-${{ github.sha }}
          restore-keys: |
            feeds-
      - name: Update feeds
        run: |
          cd ${{ needs.setup.outputs.immortal_dir }}
          ./scripts/feeds update -a
          ./scripts/feeds install -a

  compile_rootfs:
    name: Compile LXC Rootfs
    runs-on: ubuntu-22.04
    needs: [setup, update_feeds]
    env:
      IMMORTAL_DIR: ${{ needs.setup.outputs.immortal_dir }}
    steps:
      - uses: actions/checkout@v4

      - name: Restore build cache
        uses: actions/cache@v3
        with:
          path: |
            ${{ env.IMMORTAL_DIR }}/build_dir
            ${{ env.IMMORTAL_DIR }}/staging_dir
          key: build-cache-${{ github.sha }}
          restore-keys: |
            build-cache-

      - name: Apply custom config
        if: ${{ github.event.inputs.use-local-config == 'yes' }}
        run: |
          cd ${{ env.IMMORTAL_DIR }}
          test -f ${{ github.workspace }}/.config || { echo "❌ .config 不存在"; exit 1; }
          cp ${{ github.workspace }}/.config .config

      - name: Finalize config
        run: |
          cd ${{ env.IMMORTAL_DIR }}
          make defconfig
          grep CONFIG_TARGET_ROOTFS .config || true

      - name: Compile rootfs
        run: |
          cd ${{ env.IMMORTAL_DIR }}
          make -j$(nproc) target-image V=s > build.log 2>&1 || { tail -n 100 build.log; exit 1; }

      - name: Verify and compress rootfs
        run: |
          cd ${{ env.IMMORTAL_DIR }}
          TAR=$(find bin/targets -name "*rootfs.tar.gz")
          if [ -z "$TAR" ]; then
            echo "❌ 未生成 rootfs.tar.gz"
            exit 1
          fi
          gzip -9 -f "$TAR"
          echo "ROOTFS=$TAR.gz" >> $GITHUB_ENV

      - name: Clean up build_dir
        run: |
          cd ${{ env.IMMORTAL_DIR }}
          rm -rf build_dir tmp

  release:
    name: Release LXC Rootfs
    runs-on: ubuntu-22.04
    needs: compile_rootfs
    steps:
      - name: Delete old releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 1
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish new release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: immortalwrt-lxc-${{ needs.setup.outputs.immortal_version }}
          name: ImmortalWRT LXC Rootfs ${{ needs.setup.outputs.immortal_version }}
          body: "自动构建的 ImmortalWRT LXC rootfs (commit: ${{ needs.setup.outputs.immortal_commit }})"
          files: ${{ needs.compile_rootfs.outputs.ROOTFS }}
          overwrite_files: true
          make_latest: true
