name: Build ImmortalWRT LXC Rootfs

on:
  workflow_dispatch:
    inputs:
      use-local-config:
        description: '使用仓库中的 .config？'
        required: true
        default: 'yes'

permissions:
  contents: write

concurrency:
  group: immortalwrt-lxc
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential gawk flex gettext \
            libncurses5-dev libncursesw5-dev zlib1g-dev \
            libssl-dev wget unzip python3 python3-setuptools \
            rsync subversion file bc tar ccache
          echo "CCACHE_DIR=$RUNNER_TEMP/ccache" >> $GITHUB_ENV
          ccache -M 5G
          ccache -s

      - name: Clone ImmortalWRT
        run: |
          git clone --depth=50 --branch openwrt-25.12 \
            https://github.com/immortalwrt/immortalwrt.git immortalwrt
          echo "IMMORTAL_DIR=$GITHUB_WORKSPACE/immortalwrt" >> $GITHUB_ENV

      - name: Restore build cache
        uses: actions/cache@v3
        with:
          path: |
            immortalwrt/dl
            immortalwrt/build_dir
            immortalwrt/staging_dir
          key: immortalwrt-${{ runner.os }}-${{ hashFiles('.config') }}
          restore-keys: |
            immortalwrt-${{ runner.os }}-

      - name: Update & install feeds
        run: |
          cd $IMMORTAL_DIR
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply custom .config
        if: ${{ github.event.inputs.use-local-config == 'yes' }}
        run: |
          cd $IMMORTAL_DIR
          test -f $GITHUB_WORKSPACE/.config || {
            echo "❌ 仓库中未找到 .config"
            exit 1
          }
          cp $GITHUB_WORKSPACE/.config .config

      - name: Defconfig (lock config)
        run: |
          cd $IMMORTAL_DIR
          make defconfig
          echo "===== TARGET CHECK ====="
          grep -E "CONFIG_TARGET_x86_64|CONFIG_TARGET_ROOTFS_TARGZ" .config

      - name: Apply DIY customizations
        run: |
          cd $IMMORTAL_DIR
          test -f $GITHUB_WORKSPACE/diy.sh || {
            echo "❌ 未找到 diy.sh"
            exit 1
          }
          cp $GITHUB_WORKSPACE/diy.sh .
          chmod +x diy.sh
          ./diy.sh

      - name: Compile world (LXC rootfs)
        run: |
          cd $IMMORTAL_DIR
          make -j$(nproc) world V=s > build.log 2>&1 || {
            echo "❌ 编译失败，最后 100 行日志："
            tail -n 100 build.log
            exit 1
          }

      - name: Collect rootfs
        run: |
          cd $IMMORTAL_DIR
          find bin/targets -type f
          ROOTFS=$(find bin/targets -name "*rootfs.tar.gz" | head -n1)
          [ -n "$ROOTFS" ] || {
            echo "❌ 未生成 rootfs.tar.gz"
            exit 1
          }
          echo "ROOTFS=$ROOTFS" >> $GITHUB_ENV

      - name: Set release metadata
        run: |
          cd $IMMORTAL_DIR
          echo "IMMORTAL_COMMIT=$(git log -1 --format=%h)" >> $GITHUB_ENV
          echo "IMMORTAL_VERSION=$(git describe --tags --always)" >> $GITHUB_ENV
          echo "BUILD_DATE=$(date +%Y%m%d)" >> $GITHUB_ENV

      - name: Release LXC rootfs
        uses: softprops/action-gh-release@v2
        with:
          tag_name: immortalwrt-lxc-${{ env.IMMORTAL_VERSION }}-${{ env.BUILD_DATE }}
          name: ImmortalWRT LXC Rootfs
          body: |
            自动构建的 ImmortalWRT LXC Rootfs

            Commit: ${{ env.IMMORTAL_COMMIT }}
            Version: ${{ env.IMMORTAL_VERSION }}
            Date: ${{ env.BUILD_DATE }}

          files: |
            immortalwrt/bin/targets/**/sha256sums
            immortalwrt/bin/targets/**/*rootfs.tar.gz
          overwrite_files: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
