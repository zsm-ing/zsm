name: Build ImmortalWRT

on:
  workflow_dispatch:
    inputs:
      use-local-config:
        description: '是否使用仓库里的 .config 文件？(yes/no)'
        required: true
        default: 'yes'
      enable-ccache:
        description: '是否启用编译缓存？(yes/no)'
        required: true
        default: 'yes'
      make-jobs:
        description: '并行编译任务数（0=自动）'
        required: true
        default: '0'
      clean-before-build:
        description: '编译前清理目录？(yes/no)'
        required: true
        default: 'yes'

permissions:
  contents: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 240

    steps:
    - name: Record start time
      run: echo "BUILD_START=$(date +%s)" >> $GITHUB_ENV

    - name: Free up disk space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        docker-images: true
        swap-storage: true
        android: true
        dotnet: true
        large-packages: true

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install build dependencies
      run: |
        sudo apt-get update -y
        sudo apt-get install -y \
          build-essential ccache gawk flex gettext \
          libncurses5-dev libncursesw5-dev zlib1g-dev \
          libssl-dev wget unzip python3 python3-setuptools \
          subversion file bc squashfs-tools dosfstools

    - name: Setup ccache
      if: ${{ github.event.inputs['enable-ccache'] == 'yes' }}
      run: |
        mkdir -p ~/.ccache
        echo "max_size = 4G" > ~/.ccache/ccache.conf
        echo "compiler_check = content" >> ~/.ccache/ccache.conf
        echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

    - name: Clone ImmortalWRT source
      run: |
        IMMORTAL_DIR="$GITHUB_WORKSPACE/immortal-src"

        if [ -d "$IMMORTAL_DIR" ] && [ "${{ github.event.inputs['clean-before-build'] }}" = "yes" ]; then
          rm -rf "$IMMORTAL_DIR"
        fi

        git clone --branch openwrt-25.12 --depth=50 \
          https://github.com/immortalwrt/immortalwrt.git "$IMMORTAL_DIR"

        cd "$IMMORTAL_DIR"
        echo "IMMORTAL_DIR=$IMMORTAL_DIR" >> $GITHUB_ENV
        echo "IMMORTAL_COMMIT=$(git log -1 --format='%h')" >> $GITHUB_ENV

    - name: Apply config
      run: |
        cd "$IMMORTAL_DIR"
        if [ "${{ github.event.inputs['use-local-config'] }}" = "yes" ] && [ -f "$GITHUB_WORKSPACE/.config" ]; then
          cp "$GITHUB_WORKSPACE/.config" .config
        fi

    - name: Update feeds
      run: |
        cd "$IMMORTAL_DIR"
        timeout 900 ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Finalize config
      run: |
        cd "$IMMORTAL_DIR"
        make defconfig

    - name: Calculate jobs
      run: |
        if [ "${{ github.event.inputs['make-jobs'] }}" = "0" ]; then
          JOBS=$(( $(nproc) + 1 ))
        else
          JOBS=${{ github.event.inputs['make-jobs'] }}
        fi
        echo "JOBS=$JOBS" >> $GITHUB_ENV

    - name: Compile firmware
      timeout-minutes: 180
      run: |
        cd "$IMMORTAL_DIR"
        export FORCE_UNSAFE_CONFIGURE=1

        make -j$JOBS V=s || make -j$JOBS V=sc

        find bin/targets -name "*.img" | grep -q . || {
          echo "❌ 未生成 IMG 固件"
          exit 1
        }

    - name: Delete old releases (keep latest)
      uses: dev-drprasad/delete-older-releases@v0.3.4
      with:
        keep_latest: 1
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: immortalwrt-latest
        name: ImmortalWRT Latest (IMG)
        body: |
          ImmortalWRT 自动构建
          仅包含可刷写 IMG 固件

          分支: openwrt-25.12
          Commit: ${{ env.IMMORTAL_COMMIT }}

        files: |
          ${{ env.IMMORTAL_DIR }}/bin/targets/**/*.img
