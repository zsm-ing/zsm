name: Build ImmortalWRT LXC Rootfs

on:
  workflow_dispatch:
    inputs:
      use-local-config:
        description: '使用仓库中的 .config？'
        required: true
        default: 'yes'

permissions:
  contents: write

concurrency:
  group: immortalwrt-lxc
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free disk space
        uses: jlumbroso/free-disk-space@main

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential gawk flex gettext \
            libncurses5-dev libncursesw5-dev zlib1g-dev \
            libssl-dev wget unzip python3 python3-setuptools \
            rsync subversion file bc tar

      - name: Clone ImmortalWRT
        run: |
          git clone --depth=50 --branch openwrt-25.12 \
            https://github.com/immortalwrt/immortalwrt.git immortalwrt
          cd immortalwrt
          echo "IMMORTAL_DIR=$PWD" >> $GITHUB_ENV
          echo "IMMORTAL_COMMIT=$(git log -1 --format=%h)" >> $GITHUB_ENV

      # === 关键：feeds 一定在 config 之前 ===
      - name: Update feeds
        run: |
          cd "$IMMORTAL_DIR"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Apply custom config
        if: ${{ github.event.inputs.use-local-config == 'yes' }}
        run: |
          cd "$IMMORTAL_DIR"
          test -f "$GITHUB_WORKSPACE/.config" || {
            echo "❌ .config 不存在"
            exit 1
          }
          cp "$GITHUB_WORKSPACE/.config" .config

      - name: Finalize config
        run: |
          cd "$IMMORTAL_DIR"
          make defconfig

          echo "==== Rootfs config check ===="
          grep CONFIG_TARGET_ROOTFS .config || true

      - name: Compile rootfs
        run: |
          cd "$IMMORTAL_DIR"
          make -j$(nproc) world

      - name: Verify LXC rootfs
        run: |
          cd "$IMMORTAL_DIR"
          TAR=$(find bin/targets -name "*rootfs.tar.gz")
          if [ -z "$TAR" ]; then
            echo "❌ 未生成 rootfs.tar.gz"
            exit 1
          fi
            echo "ROOTFS=$TAR" >> $GITHUB_ENV

      - name: Delete old releases
        uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 1
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release LXC rootfs
        uses: softprops/action-gh-release@v2
        with:
          tag_name: immortalwrt-lxc-latest
          name: ImmortalWRT LXC Rootfs
          body: "自动构建的 ImmortalWRT LXC rootfs"
          files: ${{ env.ROOTFS }}
          overwrite_files: true
          make_latest: true
